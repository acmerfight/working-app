---
description: BDD å¼€å‘æ¨¡å¼è§„èŒƒ
globs: ["**/*.ts", "**/*.tsx"]
alwaysApply: true
---

# BDD å¼€å‘æ¨¡å¼

## å¼€å‘æµç¨‹

1. **éœ€æ±‚åˆ†æ** â†’ ç†è§£ç”¨æˆ·æ•…äº‹
2. **è®¾è®¡ BDD Case** â†’ å…ˆå†™ Given/When/Then åœºæ™¯
3. **ç¼–å†™æµ‹è¯•** â†’ æ ¹æ® BDD Case ç¼–å†™æµ‹è¯•ä»£ç 
4. **å®ç°åŠŸèƒ½** â†’ è®©æµ‹è¯•é€šè¿‡
5. **é‡æ„** â†’ ä¼˜åŒ–ä»£ç 

## BDD Case æ ¼å¼

```gherkin
Feature: [åŠŸèƒ½åç§°]
  As a [è§’è‰²]
  I want [ç›®æ ‡]
  So that [æ”¶ç›Š]

  Scenario: [åœºæ™¯åç§°]
    Given [å‰ç½®æ¡ä»¶]
    When [è§¦å‘åŠ¨ä½œ]
    Then [æœŸæœ›ç»“æœ]
```

## è§„åˆ™

- **ä»»ä½•åŠŸèƒ½å¼€å‘å‰ï¼Œå¿…é¡»å…ˆè®¾è®¡ BDD Case**
- æµ‹è¯•æ–‡ä»¶å‘½åï¼š`*.test.ts` æˆ– `*.test.tsx`
- ä½¿ç”¨ Vitest + Testing Library

---

# æµ‹è¯•æœ€ä½³å®è·µ

## æ ¸å¿ƒç­–ç•¥ï¼šå‰åç«¯é›†æˆæµ‹è¯•ï¼ˆAtoms + Honoï¼‰

æ‰€æœ‰æµ‹è¯•é€šè¿‡ Jotai Atoms è¿›è¡Œï¼ŒåŒæ—¶è°ƒç”¨çœŸå®çš„ Hono åç«¯ï¼Œ**ä¸å¯åŠ¨æœåŠ¡å™¨**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµ‹è¯•æ‰§è¡Œæµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  store.set(actionAtom)                                  â”‚
â”‚       â†“                                                 â”‚
â”‚  Atom action è°ƒç”¨ fetch('/api/xxx')                     â”‚
â”‚       â†“                                                 â”‚
â”‚  vi.stubGlobal æ‹¦æˆª â†’ è½¬å‘ç»™ app.request()              â”‚
â”‚       â†“                                                 â”‚
â”‚  Hono æœåŠ¡ç«¯ä»£ç æ‰§è¡Œï¼ˆçœŸå®ï¼ä¸å¯åŠ¨æœåŠ¡å™¨ï¼‰                â”‚
â”‚       â†“                                                 â”‚
â”‚  Atom è§£æå“åº” â†’ æ›´æ–°çŠ¶æ€                               â”‚
â”‚       â†“                                                 â”‚
â”‚  æµ‹è¯•æ–­è¨€ï¼šéªŒè¯çŠ¶æ€å˜åŒ–                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æµ‹è¯•æ–‡ä»¶ç»“æ„

```
packages/client/src/store/__tests__/
â””â”€â”€ atoms-integration.test.ts    # ç»Ÿä¸€çš„å‰åç«¯é›†æˆæµ‹è¯•
```

## æµ‹è¯•æ¨¡æ¿

```typescript
import { createStore } from "jotai";
import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
import { app } from "@working-app/server/app";
import { myAtom, myActionAtom, loadingAtom } from "../atoms";

// è¾…åŠ©å‡½æ•°ï¼šé…ç½® Hono ä½œä¸ºæµ‹è¯•åç«¯
function setupHonoFetch() {
  vi.stubGlobal(
    "fetch",
    async (input: RequestInfo | URL, init?: RequestInit) => {
      const url = typeof input === "string" ? input : input.toString();
      const fullUrl = url.startsWith("http") ? url : `http://localhost${url}`;
      return app.request(fullUrl, init);
    }
  );
}

// è¾…åŠ©å‡½æ•°ï¼šè¿½è¸ªçŠ¶æ€å˜åŒ–å†å²
function trackAtomChanges<T>(
  store: ReturnType<typeof createStore>,
  atom: typeof loadingAtom
) {
  const history: T[] = [];
  store.sub(atom, () => {
    history.push(store.get(atom) as T);
  });
  return history;
}

describe("Feature: åŠŸèƒ½åç§°", () => {
  beforeEach(() => {
    setupHonoFetch();
  });

  afterEach(() => {
    vi.unstubAllGlobals();
  });

  describe("Scenario: åœºæ™¯åç§°", () => {
    it("Given å‰ç½®æ¡ä»¶, When è§¦å‘åŠ¨ä½œ, Then æœŸæœ›ç»“æœ", async () => {
      // Given
      const store = createStore();
      expect(store.get(myAtom)).toBe(initialValue);

      // When
      await store.set(myActionAtom);

      // Then
      expect(store.get(myAtom)).toBe(expectedValue);
    });
  });
});
```

## å¿…é¡»éªŒè¯çš„å†…å®¹

### 1. çŠ¶æ€å˜åŒ–

```typescript
it("åº”è¯¥æ­£ç¡®æ›´æ–°çŠ¶æ€", async () => {
  const store = createStore();

  await store.set(fetchDataAtom);

  expect(store.get(dataAtom)).toBe("expected value");
});
```

### 2. Loading çŠ¶æ€ï¼ˆå¿…é¡»ï¼ï¼‰

```typescript
it("Loading çŠ¶æ€åº”è¯¥ç»å† false â†’ true â†’ false", async () => {
  const store = createStore();
  const loadingHistory = trackAtomChanges<boolean>(store, loadingAtom);

  await store.set(fetchDataAtom);

  expect(loadingHistory).toEqual([true, false]);
});
```

### 3. é”™è¯¯å¤„ç†

```typescript
it("ç½‘ç»œé”™è¯¯æ—¶åº”è¯¥æ­£ç¡®è®¾ç½®é”™è¯¯çŠ¶æ€", async () => {
  const store = createStore();
  vi.stubGlobal("fetch", vi.fn().mockRejectedValue(new Error("Network error")));

  await store.set(fetchDataAtom);

  expect(store.get(errorAtom)).toBe("Network error");
  expect(store.get(loadingAtom)).toBe(false); // å³ä½¿å‡ºé”™ä¹Ÿè¦ç»“æŸ loading
});
```

## è·¨åŒ…å¯¼å…¥é…ç½®

ä½¿ç”¨ TypeScript Project References å®ç°ç±»å‹å®‰å…¨çš„è·¨åŒ…å¯¼å…¥ï¼š

### Server åŒ… (`package.json`)

```json
{
  "exports": {
    "./app": {
      "types": "./src/app.ts",
      "default": "./src/app.ts"
    }
  }
}
```

### Client åŒ… (`tsconfig.json`)

```json
{
  "references": [{ "path": "../shared" }, { "path": "../server" }]
}
```

### Vitest é…ç½® (`vitest.config.ts`)

```typescript
resolve: {
  alias: {
    "@working-app/server": resolve(__dirname, "../server/src"),
  },
}
```

## ç¤ºä¾‹ï¼šå®Œæ•´çš„ BDD æµ‹è¯•

```gherkin
Feature: API äº¤äº’
  As a ç”¨æˆ·
  I want è·å–æœåŠ¡å™¨æ¶ˆæ¯
  So that å¯ä»¥çœ‹åˆ°æœ€æ–°å†…å®¹

  Scenario: è·å–é—®å€™æ¶ˆæ¯
    Given ç”¨æˆ·æ‰“å¼€é¡µé¢
    When è°ƒç”¨ fetchMessage
    Then åº”è¯¥æ˜¾ç¤ºæœåŠ¡å™¨é—®å€™è¯­
    And Loading çŠ¶æ€åº”è¯¥ç»å† false â†’ true â†’ false
```

å¯¹åº”çš„æµ‹è¯•ä»£ç ï¼š

```typescript
describe("Feature: API äº¤äº’", () => {
  beforeEach(() => setupHonoFetch());
  afterEach(() => vi.unstubAllGlobals());

  describe("Scenario: è·å–é—®å€™æ¶ˆæ¯", () => {
    it("Given ç”¨æˆ·æ‰“å¼€é¡µé¢, When è°ƒç”¨ fetchMessage, Then åº”è¯¥æ˜¾ç¤ºæœåŠ¡å™¨é—®å€™è¯­", async () => {
      const store = createStore();
      const loadingHistory = trackAtomChanges<boolean>(store, apiLoadingAtom);

      await store.set(fetchMessageAtom);

      expect(store.get(apiMessageAtom)).toBe("Hello from Hono! ğŸ”¥");
      expect(loadingHistory).toEqual([true, false]);
    });
  });
});
```

## ä¼˜åŠ¿

| ä¼˜åŠ¿        | è¯´æ˜                             |
| ----------- | -------------------------------- |
| âš¡ å¿«é€Ÿ     | æ— ç½‘ç»œå¼€é”€ï¼Œæ¯«ç§’çº§è¿è¡Œ           |
| ğŸ”— çœŸå®     | æµ‹è¯•çœŸå®çš„åç«¯é€»è¾‘               |
| ğŸš« æ— ç«¯å£   | ä¸å ç”¨ç«¯å£ï¼ŒCI å‹å¥½              |
| ğŸ¯ ç«¯åˆ°ç«¯   | å‰ç«¯çŠ¶æ€ â†’ API â†’ åç«¯ â†’ çŠ¶æ€æ›´æ–° |
| ğŸ“ BDD æ ¼å¼ | Given/When/Then ç»“æ„æ¸…æ™°         |
